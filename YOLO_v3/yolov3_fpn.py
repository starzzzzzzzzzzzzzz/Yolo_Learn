"""
YOLOv3 FPN é£æ ¼ç‰¹å¾èåˆ
å±•ç¤ºå¦‚ä½•ä» Darknet-53 çš„ä¸‰ä¸ªè¾“å‡ºæ„å»ºå®Œæ•´çš„ YOLOv3
"""

import torch
import torch.nn as nn
import torch.nn.functional as F


# ================================
# 1. åŸºç¡€å·ç§¯å—ï¼ˆå¤ç”¨ï¼‰
# ================================

class ConvBlock(nn.Module):
    """Conv + BN + Leaky ReLU"""
    def __init__(self, in_channels, out_channels, kernel_size, stride=1):
        super(ConvBlock, self).__init__()
        padding = (kernel_size - 1) // 2
        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size, stride, padding, bias=False)
        self.bn = nn.BatchNorm2d(out_channels)
        self.activation = nn.LeakyReLU(0.1, inplace=True)
    
    def forward(self, x):
        return self.activation(self.bn(self.conv(x)))


# ================================
# 2. YOLOv3 æ£€æµ‹å—
# ================================

class YOLOv3DetectionBlock(nn.Module):
    """
    YOLOv3 çš„æ£€æµ‹å—
    5 ä¸ªå·ç§¯å±‚ + æ£€æµ‹å±‚
    """
    def __init__(self, in_channels, num_anchors=3, num_classes=80):
        super(YOLOv3DetectionBlock, self).__init__()
        
        # 5 ä¸ªå·ç§¯å±‚ï¼ˆç‰¹å¾æå–ï¼‰
        self.conv1 = ConvBlock(in_channels, in_channels // 2, 1)
        self.conv2 = ConvBlock(in_channels // 2, in_channels, 3)
        self.conv3 = ConvBlock(in_channels, in_channels // 2, 1)
        self.conv4 = ConvBlock(in_channels // 2, in_channels, 3)
        self.conv5 = ConvBlock(in_channels, in_channels // 2, 1)
        
        # æ£€æµ‹å±‚å‰çš„å·ç§¯
        self.conv6 = ConvBlock(in_channels // 2, in_channels, 3)
        
        # æ£€æµ‹å±‚ï¼ˆé¢„æµ‹ï¼‰
        self.conv7 = nn.Conv2d(
            in_channels, 
            num_anchors * (5 + num_classes),  # æ¯ä¸ª anchor: tx,ty,tw,th,conf + classes
            kernel_size=1
        )
    
    def forward(self, x):
        x = self.conv1(x)
        x = self.conv2(x)
        x = self.conv3(x)
        x = self.conv4(x)
        x = self.conv5(x)  # â† è¿™ä¸ªç‰¹å¾ä¼šç”¨äºä¸Šé‡‡æ ·
        
        route = x  # ä¿å­˜ç”¨äºåç»­èåˆ
        
        x = self.conv6(x)
        detection = self.conv7(x)  # æ£€æµ‹è¾“å‡º
        
        return detection, route


# ================================
# 3. YOLOv3 å®Œæ•´ç½‘ç»œï¼ˆFPN èåˆï¼‰
# ================================

class YOLOv3(nn.Module):
    """
    YOLOv3 å®Œæ•´ç½‘ç»œ
    æ ¸å¿ƒï¼šFPN é£æ ¼çš„è‡ªé¡¶å‘ä¸‹ç‰¹å¾èåˆ
    """
    
    def __init__(self, backbone, num_anchors=3, num_classes=80):
        super(YOLOv3, self).__init__()
        
        self.backbone = backbone
        self.num_anchors = num_anchors
        self.num_classes = num_classes
        
        # ===== ç¬¬ä¸€ä¸ªæ£€æµ‹å¤´ï¼ˆ13Ã—13ï¼Œå¤§ç›®æ ‡ï¼‰=====
        self.detection_block_1 = YOLOv3DetectionBlock(1024, num_anchors, num_classes)
        
        # ç”¨äºä¸Šé‡‡æ ·çš„å·ç§¯
        self.upsample_conv_1 = ConvBlock(512, 256, 1)
        self.upsample_1 = nn.Upsample(scale_factor=2, mode='nearest')
        
        # ===== ç¬¬äºŒä¸ªæ£€æµ‹å¤´ï¼ˆ26Ã—26ï¼Œä¸­ç›®æ ‡ï¼‰=====
        # è¾“å…¥ï¼š256 (ä¸Šé‡‡æ ·) + 512 (éª¨å¹²) = 768
        self.detection_block_2 = YOLOv3DetectionBlock(768, num_anchors, num_classes)
        
        # ç”¨äºä¸Šé‡‡æ ·çš„å·ç§¯
        self.upsample_conv_2 = ConvBlock(384, 128, 1)
        self.upsample_2 = nn.Upsample(scale_factor=2, mode='nearest')
        
        # ===== ç¬¬ä¸‰ä¸ªæ£€æµ‹å¤´ï¼ˆ52Ã—52ï¼Œå°ç›®æ ‡ï¼‰=====
        # è¾“å…¥ï¼š128 (ä¸Šé‡‡æ ·) + 256 (éª¨å¹²) = 384
        self.detection_block_3 = YOLOv3DetectionBlock(384, num_anchors, num_classes)
    
    def forward(self, x):
        """
        x: (B, 3, 416, 416)
        è¿”å› 3 ä¸ªä¸åŒå°ºåº¦çš„æ£€æµ‹ç»“æœ
        """
        # éª¨å¹²ç½‘ç»œæå–ç‰¹å¾
        out_52, out_26, out_13 = self.backbone(x)
        # out_52: (B, 256, 52, 52)  â† æµ…å±‚ï¼Œç»†èŠ‚ä¸°å¯Œ
        # out_26: (B, 512, 26, 26)  â† ä¸­å±‚
        # out_13: (B, 1024, 13, 13) â† æ·±å±‚ï¼Œè¯­ä¹‰ä¸°å¯Œ
        
        # ========================================
        # ç¬¬ 1 æ­¥ï¼š13Ã—13 æ£€æµ‹ï¼ˆå¤§ç›®æ ‡ï¼‰
        # ========================================
        detection_13, route_13 = self.detection_block_1(out_13)
        # detection_13: (B, 3*(5+80), 13, 13) - æ£€æµ‹è¾“å‡º
        # route_13: (B, 512, 13, 13) - ç”¨äºä¸Šé‡‡æ ·
        
        # ========================================
        # ç¬¬ 2 æ­¥ï¼š13Ã—13 â†’ 26Ã—26 èåˆ
        # ========================================
        # ä¸Šé‡‡æ ·
        x = self.upsample_conv_1(route_13)  # (B, 512, 13, 13) â†’ (B, 256, 13, 13)
        x = self.upsample_1(x)              # (B, 256, 13, 13) â†’ (B, 256, 26, 26)
        
        # èåˆï¼šæ·±å±‚ä¸Šé‡‡æ · + æµ…å±‚ç‰¹å¾
        x = torch.cat([x, out_26], dim=1)   # (B, 256, 26, 26) + (B, 512, 26, 26) = (B, 768, 26, 26)
        
        # 26Ã—26 æ£€æµ‹ï¼ˆä¸­ç›®æ ‡ï¼‰
        detection_26, route_26 = self.detection_block_2(x)
        # detection_26: (B, 3*(5+80), 26, 26) - æ£€æµ‹è¾“å‡º
        # route_26: (B, 384, 26, 26) - ç”¨äºä¸Šé‡‡æ ·
        
        # ========================================
        # ç¬¬ 3 æ­¥ï¼š26Ã—26 â†’ 52Ã—52 èåˆ
        # ========================================
        # ä¸Šé‡‡æ ·
        x = self.upsample_conv_2(route_26)  # (B, 384, 26, 26) â†’ (B, 128, 26, 26)
        x = self.upsample_2(x)              # (B, 128, 26, 26) â†’ (B, 128, 52, 52)
        
        # èåˆï¼šä¸­å±‚ä¸Šé‡‡æ · + æµ…å±‚ç‰¹å¾
        x = torch.cat([x, out_52], dim=1)   # (B, 128, 52, 52) + (B, 256, 52, 52) = (B, 384, 52, 52)
        
        # 52Ã—52 æ£€æµ‹ï¼ˆå°ç›®æ ‡ï¼‰
        detection_52, _ = self.detection_block_3(x)
        # detection_52: (B, 3*(5+80), 52, 52) - æ£€æµ‹è¾“å‡º
        
        return detection_13, detection_26, detection_52


# ================================
# 4. å®Œæ•´æµç¨‹å¯è§†åŒ–
# ================================

def visualize_fpn_flow():
    """å¯è§†åŒ– FPN èåˆæµç¨‹"""
    print("=" * 80)
    print("YOLOv3 FPN èåˆæµç¨‹ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰")
    print("=" * 80)
    
    flow = """
    éª¨å¹²ç½‘ç»œ Darknet-53 è¾“å‡º:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ out_52: (B, 256, 52, 52)   æµ…å±‚    â”‚ â† ç»†èŠ‚ä¸°å¯Œï¼Œå®šä½å‡†
    â”‚ out_26: (B, 512, 26, 26)   ä¸­å±‚    â”‚
    â”‚ out_13: (B, 1024, 13, 13)  æ·±å±‚    â”‚ â† è¯­ä¹‰ä¸°å¯Œï¼Œè¯†åˆ«å‡†
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ç¬¬ 1 å±‚ï¼š13Ã—13 æ£€æµ‹ï¼ˆå¤§ç›®æ ‡ï¼‰
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    out_13 (1024, 13, 13)
        â†“
    [DetectionBlock] â† 5ä¸ªå·ç§¯æå–ç‰¹å¾
        â†“
    â”œâ”€â†’ detection_13 (255, 13, 13)  âœ… ç¬¬1ä¸ªæ£€æµ‹è¾“å‡ºï¼ˆå¤§ç›®æ ‡ï¼‰
    â””â”€â†’ route_13 (512, 13, 13)      â†’ ç”¨äºä¸Šé‡‡æ ·
    
    
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ç¬¬ 2 å±‚ï¼š26Ã—26 èåˆ + æ£€æµ‹ï¼ˆä¸­ç›®æ ‡ï¼‰
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    route_13 (512, 13, 13)
        â†“ Conv 1Ã—1 é™ç»´
    (256, 13, 13)
        â†“ Upsample 2Ã—  â† ä¸Šé‡‡æ ·ï¼
    (256, 26, 26)
        â†“
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” Concat  â† èåˆï¼
        â†“         â†“
    (256, 26, 26) + out_26 (512, 26, 26)
        â†“
    (768, 26, 26)  â† èåˆåçš„ç‰¹å¾
        â†“
    [DetectionBlock]
        â†“
    â”œâ”€â†’ detection_26 (255, 26, 26)  âœ… ç¬¬2ä¸ªæ£€æµ‹è¾“å‡ºï¼ˆä¸­ç›®æ ‡ï¼‰
    â””â”€â†’ route_26 (384, 26, 26)      â†’ ç”¨äºä¸Šé‡‡æ ·
    
    
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ç¬¬ 3 å±‚ï¼š52Ã—52 èåˆ + æ£€æµ‹ï¼ˆå°ç›®æ ‡ï¼‰
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    route_26 (384, 26, 26)
        â†“ Conv 1Ã—1 é™ç»´
    (128, 26, 26)
        â†“ Upsample 2Ã—  â† ä¸Šé‡‡æ ·ï¼
    (128, 52, 52)
        â†“
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” Concat  â† èåˆï¼
        â†“         â†“
    (128, 52, 52) + out_52 (256, 52, 52)
        â†“
    (384, 52, 52)  â† èåˆåçš„ç‰¹å¾
        â†“
    [DetectionBlock]
        â†“
    detection_52 (255, 52, 52)  âœ… ç¬¬3ä¸ªæ£€æµ‹è¾“å‡ºï¼ˆå°ç›®æ ‡ï¼‰
    
    
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    æœ€ç»ˆè¾“å‡º
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    detection_13: (B, 255, 13, 13)  â†’ 13Ã—13Ã—3 = 507 ä¸ªå¤§ç›®æ ‡æ¡†
    detection_26: (B, 255, 26, 26)  â†’ 26Ã—26Ã—3 = 2028 ä¸ªä¸­ç›®æ ‡æ¡†
    detection_52: (B, 255, 52, 52)  â†’ 52Ã—52Ã—3 = 8112 ä¸ªå°ç›®æ ‡æ¡†
    
    æ€»è®¡ï¼š10647 ä¸ªé¢„æµ‹æ¡†ï¼
    """
    
    print(flow)


# ================================
# 5. å…³é”®ä»£ç ç‰‡æ®µå¯¹æ¯”
# ================================

def compare_fusion_methods():
    """å¯¹æ¯” YOLOv2 å’Œ YOLOv3 çš„èåˆæ–¹å¼"""
    print("\n" + "=" * 80)
    print("YOLOv2 vs YOLOv3 èåˆæ–¹å¼å¯¹æ¯”")
    print("=" * 80)
    
    comparison = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                    YOLOv2 Passthrough                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    26Ã—26Ã—512 (æµ…å±‚)
        â†“ Passthrough (space-to-depth)
    13Ã—13Ã—2048
        â†“ Concat
    13Ã—13Ã—(1024+2048) = 13Ã—13Ã—3072
        â†“ å·ç§¯
    13Ã—13 é¢„æµ‹ â† åªæœ‰ä¸€ä¸ªè¾“å‡º
    
    ç‰¹ç‚¹ï¼š
    â€¢ å•å‘èåˆï¼ˆæµ… â†’ æ·±ï¼‰
    â€¢ åªæœ‰ä¸€ä¸ªé¢„æµ‹å°ºåº¦
    â€¢ Passthrough æ˜¯ç©ºé—´åˆ°é€šé“çš„é‡ç»„
    
    
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                    YOLOv3 FPN é£æ ¼                                     â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    æ·±å±‚ 13Ã—13Ã—1024
        â†“ æ£€æµ‹
    13Ã—13 é¢„æµ‹ â† è¾“å‡º1ï¼ˆå¤§ç›®æ ‡ï¼‰âœ…
        â†“ Upsample + Conv
    13Ã—13Ã—512 â†’ 26Ã—26Ã—256
        â†“ Concat â† èåˆ
    26Ã—26Ã—(256+512) = 26Ã—26Ã—768
        â†“ æ£€æµ‹
    26Ã—26 é¢„æµ‹ â† è¾“å‡º2ï¼ˆä¸­ç›®æ ‡ï¼‰âœ…
        â†“ Upsample + Conv
    26Ã—26Ã—384 â†’ 52Ã—52Ã—128
        â†“ Concat â† èåˆ
    52Ã—52Ã—(128+256) = 52Ã—52Ã—384
        â†“ æ£€æµ‹
    52Ã—52 é¢„æµ‹ â† è¾“å‡º3ï¼ˆå°ç›®æ ‡ï¼‰âœ…
    
    ç‰¹ç‚¹ï¼š
    â€¢ è‡ªé¡¶å‘ä¸‹èåˆï¼ˆæ·± â†’ æµ…ï¼‰
    â€¢ ä¸‰ä¸ªé¢„æµ‹å°ºåº¦
    â€¢ æ¯ä¸€å±‚éƒ½èåˆ + é¢„æµ‹
    â€¢ ç±»ä¼¼ FPN (Feature Pyramid Network)
    
    
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                      æ ¸å¿ƒåŒºåˆ«                                          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç‰¹æ€§       â”‚      YOLOv2         â”‚         YOLOv3           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ èåˆæ–¹å‘     â”‚ æµ… â†’ æ·±ï¼ˆå•å‘ï¼‰     â”‚ æ·± â†’ æµ…ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰â­   â”‚
    â”‚ èåˆæ–¹å¼     â”‚ Passthrough é‡ç»„    â”‚ Upsample + Concat â­     â”‚
    â”‚ èåˆæ¬¡æ•°     â”‚ 1 æ¬¡                â”‚ 2 æ¬¡ï¼ˆæ›´å……åˆ†ï¼‰           â”‚
    â”‚ é¢„æµ‹å°ºåº¦     â”‚ 1 ä¸ª (13Ã—13)        â”‚ 3 ä¸ª (13,26,52) â­       â”‚
    â”‚ é¢„æµ‹æ¡†æ•°     â”‚ 845                 â”‚ 10647 (æ›´å¤š)             â”‚
    â”‚ å°ç›®æ ‡æ£€æµ‹   â”‚ è¾ƒå¼±                â”‚ å¼º â­â­â­                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    
    print(comparison)


# ================================
# 6. æµ‹è¯•
# ================================

def test_yolov3_fpn():
    """æµ‹è¯• YOLOv3 FPN èåˆ"""
    print("\n" + "=" * 80)
    print("YOLOv3 FPN æµ‹è¯•")
    print("=" * 80)
    
    # ç®€åŒ–çš„éª¨å¹²ç½‘ç»œï¼ˆæ¨¡æ‹Ÿ Darknet-53ï¼‰
    class SimplifiedBackbone(nn.Module):
        def __init__(self):
            super().__init__()
        
        def forward(self, x):
            B = x.size(0)
            # æ¨¡æ‹Ÿä¸‰ä¸ªè¾“å‡º
            out_52 = torch.randn(B, 256, 52, 52)
            out_26 = torch.randn(B, 512, 26, 26)
            out_13 = torch.randn(B, 1024, 13, 13)
            return out_52, out_26, out_13
    
    # åˆ›å»ºæ¨¡å‹
    backbone = SimplifiedBackbone()
    model = YOLOv3(backbone, num_anchors=3, num_classes=80)
    model.eval()
    
    # æµ‹è¯•
    x = torch.randn(2, 3, 416, 416)
    
    with torch.no_grad():
        det_13, det_26, det_52 = model(x)
    
    print(f"\nè¾“å…¥: {x.shape}")
    print(f"\nä¸‰ä¸ªæ£€æµ‹è¾“å‡º:")
    print(f"  13Ã—13: {det_13.shape}  â†’ {13*13*3} ä¸ªæ¡†ï¼ˆå¤§ç›®æ ‡ï¼‰")
    print(f"  26Ã—26: {det_26.shape}  â†’ {26*26*3} ä¸ªæ¡†ï¼ˆä¸­ç›®æ ‡ï¼‰")
    print(f"  52Ã—52: {det_52.shape}  â†’ {52*52*3} ä¸ªæ¡†ï¼ˆå°ç›®æ ‡ï¼‰")
    print(f"\næ€»é¢„æµ‹æ¡†æ•°: {13*13*3 + 26*26*3 + 52*52*3} ä¸ª")
    
    print("\nâœ… FPN èåˆæˆåŠŸï¼")
    print("\nå…³é”®ç‚¹:")
    print("  1. è‡ªé¡¶å‘ä¸‹ï¼ˆ13 â†’ 26 â†’ 52ï¼‰")
    print("  2. æ¯å±‚éƒ½èåˆï¼šUpsample + Concat")
    print("  3. æ¯å±‚éƒ½é¢„æµ‹ï¼š3 ä¸ªç‹¬ç«‹æ£€æµ‹å¤´")
    print("  4. å°ç›®æ ‡æ£€æµ‹å¤§å¹…æå‡ï¼ˆ52Ã—52 é«˜åˆ†è¾¨ç‡ï¼‰")


# ================================
# ä¸»å‡½æ•°
# ================================

if __name__ == "__main__":
    # å¯è§†åŒ–èåˆæµç¨‹
    visualize_fpn_flow()
    
    # å¯¹æ¯”èåˆæ–¹æ³•
    compare_fusion_methods()
    
    # æµ‹è¯•
    test_yolov3_fpn()
    
    print("\n" + "=" * 80)
    print("ğŸ‰ YOLOv3 FPN èåˆå­¦ä¹ å®Œæˆï¼")
    print("=" * 80)
    print("\næ ¸å¿ƒè¦ç‚¹:")
    print("  1. è‡ªé¡¶å‘ä¸‹ç‰¹å¾èåˆï¼ˆæ·±å±‚è¯­ä¹‰ â†’ æµ…å±‚ç»†èŠ‚ï¼‰")
    print("  2. Upsample + Concatï¼ˆè€Œä¸æ˜¯ addï¼‰")
    print("  3. ä¸‰ä¸ªç‹¬ç«‹çš„æ£€æµ‹å¤´ï¼ˆå¤šå°ºåº¦é¢„æµ‹ï¼‰")
    print("  4. 52Ã—52 é«˜åˆ†è¾¨ç‡ â†’ å°ç›®æ ‡æ£€æµ‹æå‡ â­â­â­")

