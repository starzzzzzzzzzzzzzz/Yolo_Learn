"""
Darknet-53 å®ç°ï¼ˆYOLOv3 éª¨å¹²ç½‘ç»œï¼‰
æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. å¼•å…¥æ®‹å·®è¿æ¥ï¼ˆResNet æ€æƒ³ï¼‰
2. 53 å±‚å·ç§¯ç½‘ç»œ
3. æ²¡æœ‰æ± åŒ–å±‚ï¼Œç”¨æ­¥é•¿ä¸º 2 çš„å·ç§¯ä¸‹é‡‡æ ·
"""

import torch
import torch.nn as nn
import torch.nn.functional as F


# ================================
# 1. åŸºç¡€å·ç§¯å—
# ================================

class ConvBlock(nn.Module):
    """åŸºç¡€å·ç§¯å—ï¼šConv + BN + Leaky ReLU"""
    
    def __init__(self, in_channels, out_channels, kernel_size, stride=1):
        super(ConvBlock, self).__init__()
        
        padding = (kernel_size - 1) // 2  # ä¿æŒå°ºå¯¸
        
        self.conv = nn.Conv2d(
            in_channels, 
            out_channels, 
            kernel_size, 
            stride, 
            padding,
            bias=False  # BN å±‚ä¼šæœ‰ bias
        )
        self.bn = nn.BatchNorm2d(out_channels)
        self.activation = nn.LeakyReLU(0.1, inplace=True)
    
    def forward(self, x):
        x = self.conv(x)
        x = self.bn(x)
        x = self.activation(x)
        return x


# ================================
# 2. æ®‹å·®å—ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼ï¼‰
# ================================

class ResidualBlock(nn.Module):
    """
    æ®‹å·®å—ï¼ˆYOLOv3 çš„å…³é”®ï¼‰
    
    ç»“æ„ï¼š
    x â†’ Conv 1Ã—1 (é™ç»´) â†’ Conv 3Ã—3 (å‡ç»´) â†’ (+) x
                                              â†‘
                                         æ®‹å·®è¿æ¥
    """
    
    def __init__(self, channels):
        super(ResidualBlock, self).__init__()
        
        # 1Ã—1 å·ç§¯é™ç»´ï¼ˆå‡å°‘è®¡ç®—é‡ï¼‰
        self.conv1 = ConvBlock(channels, channels // 2, kernel_size=1)
        
        # 3Ã—3 å·ç§¯å‡ç»´ï¼ˆæå–ç‰¹å¾ï¼‰
        self.conv2 = ConvBlock(channels // 2, channels, kernel_size=3)
    
    def forward(self, x):
        residual = x  # ä¿å­˜è¾“å…¥ï¼ˆæ®‹å·®è¿æ¥ï¼‰
        
        x = self.conv1(x)  # 1Ã—1 é™ç»´
        x = self.conv2(x)  # 3Ã—3 å‡ç»´
        
        x = x + residual  # æ®‹å·®è¿æ¥ï¼ˆå…³é”®ï¼ï¼‰
        
        return x


# ================================
# 3. æ®‹å·®å—ç»„ï¼ˆå¤šä¸ªæ®‹å·®å—å †å ï¼‰
# ================================

class ResidualBlockGroup(nn.Module):
    """
    æ®‹å·®å—ç»„ï¼šå…ˆä¸‹é‡‡æ ·ï¼Œå†å †å  n ä¸ªæ®‹å·®å—
    """
    
    def __init__(self, in_channels, out_channels, num_blocks):
        super(ResidualBlockGroup, self).__init__()
        
        # ä¸‹é‡‡æ ·ï¼ˆç”¨æ­¥é•¿ä¸º 2 çš„å·ç§¯ä»£æ›¿æ± åŒ–ï¼‰
        self.downsample = ConvBlock(in_channels, out_channels, kernel_size=3, stride=2)
        
        # å †å  num_blocks ä¸ªæ®‹å·®å—
        self.blocks = nn.ModuleList([
            ResidualBlock(out_channels) for _ in range(num_blocks)
        ])
    
    def forward(self, x):
        x = self.downsample(x)  # ä¸‹é‡‡æ ·
        
        for block in self.blocks:
            x = block(x)  # æ®‹å·®å—
        
        return x


# ================================
# 4. å®Œæ•´çš„ Darknet-53
# ================================

class Darknet53(nn.Module):
    """
    Darknet-53 éª¨å¹²ç½‘ç»œ
    
    æ¶æ„ï¼š
    è¾“å…¥ 416Ã—416
    â”œâ”€ Conv (stride=1)      â†’ 416Ã—416Ã—32
    â”œâ”€ ResGroupÃ—1 (stride=2) â†’ 208Ã—208Ã—64
    â”œâ”€ ResGroupÃ—2 (stride=2) â†’ 104Ã—104Ã—128
    â”œâ”€ ResGroupÃ—8 (stride=2) â†’ 52Ã—52Ã—256   â† è¾“å‡º1ï¼ˆç”¨äº 52Ã—52 é¢„æµ‹ï¼‰
    â”œâ”€ ResGroupÃ—8 (stride=2) â†’ 26Ã—26Ã—512   â† è¾“å‡º2ï¼ˆç”¨äº 26Ã—26 é¢„æµ‹ï¼‰
    â””â”€ ResGroupÃ—4 (stride=2) â†’ 13Ã—13Ã—1024  â† è¾“å‡º3ï¼ˆç”¨äº 13Ã—13 é¢„æµ‹ï¼‰
    
    æ€»å±‚æ•°ï¼š1 + 2*(1+2+8+8+4) = 1 + 2*23 = 1 + 46 = 47ï¼Ÿ
    å®é™…ï¼š1 + (2+4+16+16+8) = 1 + 46 = 47 å·ç§¯å±‚
          + 5 ä¸ªä¸‹é‡‡æ ·å·ç§¯ + 1 = 53 å±‚ï¼
    """
    
    def __init__(self):
        super(Darknet53, self).__init__()
        
        # åˆå§‹å·ç§¯ï¼ˆä¸ä¸‹é‡‡æ ·ï¼‰
        self.conv1 = ConvBlock(3, 32, kernel_size=3, stride=1)
        
        # æ®‹å·®å—ç»„ï¼ˆé€æ­¥ä¸‹é‡‡æ ·ï¼‰
        self.group1 = ResidualBlockGroup(32, 64, num_blocks=1)    # 1 ä¸ªæ®‹å·®å—
        self.group2 = ResidualBlockGroup(64, 128, num_blocks=2)   # 2 ä¸ªæ®‹å·®å—
        self.group3 = ResidualBlockGroup(128, 256, num_blocks=8)  # 8 ä¸ªæ®‹å·®å— â† è¾“å‡ºç”¨äº 52Ã—52
        self.group4 = ResidualBlockGroup(256, 512, num_blocks=8)  # 8 ä¸ªæ®‹å·®å— â† è¾“å‡ºç”¨äº 26Ã—26
        self.group5 = ResidualBlockGroup(512, 1024, num_blocks=4) # 4 ä¸ªæ®‹å·®å— â† è¾“å‡ºç”¨äº 13Ã—13
    
    def forward(self, x):
        """
        x: (batch, 3, 416, 416)
        è¿”å› 3 ä¸ªä¸åŒå°ºåº¦çš„ç‰¹å¾å›¾
        """
        x = self.conv1(x)    # (B, 32, 416, 416)
        
        x = self.group1(x)   # (B, 64, 208, 208)
        x = self.group2(x)   # (B, 128, 104, 104)
        
        out_52 = self.group3(x)  # (B, 256, 52, 52)   â† è¾“å‡º1ï¼ˆç»†èŠ‚ä¸°å¯Œï¼‰
        out_26 = self.group4(out_52)  # (B, 512, 26, 26)  â† è¾“å‡º2ï¼ˆä¸­ç­‰è¯­ä¹‰ï¼‰
        out_13 = self.group5(out_26)  # (B, 1024, 13, 13) â† è¾“å‡º3ï¼ˆé«˜å±‚è¯­ä¹‰ï¼‰
        
        return out_52, out_26, out_13


# ================================
# 5. å¯¹æ¯” Darknet-19 å’Œ Darknet-53
# ================================

def compare_architectures():
    """å¯¹æ¯”ä¸¤ç§æ¶æ„"""
    print("=" * 80)
    print("Darknet-19 vs Darknet-53 å¯¹æ¯”")
    print("=" * 80)
    
    comparison = """
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     ç‰¹æ€§        â”‚    Darknet-19        â”‚      Darknet-53         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ å±‚æ•°            â”‚ 19 å±‚                â”‚ 53 å±‚                   â”‚
    â”‚ æ®‹å·®è¿æ¥        â”‚ æ—  âŒ                â”‚ æœ‰ âœ…ï¼ˆå…³é”®ï¼ï¼‰         â”‚
    â”‚ ä¸‹é‡‡æ ·æ–¹å¼      â”‚ MaxPool              â”‚ æ­¥é•¿ä¸º2çš„å·ç§¯           â”‚
    â”‚ è¾“å‡º            â”‚ 1 ä¸ª (13Ã—13)         â”‚ 3 ä¸ª (52Ã—52,26Ã—26,13Ã—13)â”‚
    â”‚ æ¢¯åº¦æµ          â”‚ è¾ƒå¼±                 â”‚ å¼ºï¼ˆæ®‹å·®ï¼‰              â”‚
    â”‚ æ·±åº¦ç“¶é¢ˆ        â”‚ æœ‰ï¼ˆéš¾è®­ç»ƒï¼‰         â”‚ æ— ï¼ˆæ®‹å·®è§£å†³ï¼‰          â”‚
    â”‚ å‚æ•°é‡          â”‚ ~50M                 â”‚ ~42Mï¼ˆæ›´é«˜æ•ˆï¼‰          â”‚
    â”‚ æ€§èƒ½            â”‚ è¾ƒå¥½                 â”‚ æ›´å¥½ â­                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    å…³é”®åŒºåˆ«ï¼š
    1. æ®‹å·®è¿æ¥ï¼ˆResNet æ€æƒ³ï¼‰
       â€¢ è§£å†³æ¢¯åº¦æ¶ˆå¤±é—®é¢˜
       â€¢ å…è®¸ç½‘ç»œæ›´æ·±
       â€¢ æ€§èƒ½æå‡æ˜æ˜¾
    
    2. å¤šå°ºåº¦è¾“å‡º
       â€¢ Darknet-19: åªè¾“å‡º 13Ã—13
       â€¢ Darknet-53: è¾“å‡º 52Ã—52, 26Ã—26, 13Ã—13
       â€¢ ä¸º YOLOv3 çš„å¤šå°ºåº¦é¢„æµ‹æä¾›åŸºç¡€
    
    3. å»æ‰ MaxPool
       â€¢ ç”¨æ­¥é•¿ä¸º 2 çš„å·ç§¯ä¸‹é‡‡æ ·
       â€¢ é¿å…ä¿¡æ¯ä¸¢å¤±
       â€¢ æ›´å¹³æ»‘çš„ç‰¹å¾ä¼ é€’
    """
    
    print(comparison)


# ================================
# 6. æ®‹å·®å—è¯¦è§£
# ================================

def explain_residual_block():
    """è§£é‡Šæ®‹å·®å—çš„å·¥ä½œåŸç†"""
    print("\n" + "=" * 80)
    print("æ®‹å·®å—ï¼ˆResidual Blockï¼‰è¯¦è§£")
    print("=" * 80)
    
    explanation = """
    æ™®é€šç½‘ç»œçš„é—®é¢˜ï¼š
    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”
    â”‚  x  â”‚ â†’ â”‚Conv1â”‚ â†’ â”‚Conv2â”‚ â†’ â”‚ out â”‚
    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜
    
    é—®é¢˜ï¼š
    â€¢ ç½‘ç»œè¶Šæ·±ï¼Œæ¢¯åº¦è¶Šéš¾ä¼ å›
    â€¢ æ€§èƒ½ä¸‹é™ï¼ˆé€€åŒ–é—®é¢˜ï¼‰
    â€¢ éš¾ä»¥è®­ç»ƒ
    
    
    æ®‹å·®å—çš„è§£å†³æ–¹æ¡ˆï¼š
    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”
    â”‚  x  â”‚ â†’ â”‚Conv1â”‚ â†’ â”‚Conv2â”‚ â†’ â”‚ (+) â”‚ â†’ â”‚ out â”‚
    â””â”€â”€â”¬â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â–²â”€â”€â”˜
       â”‚                                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              æ®‹å·®è¿æ¥ï¼ˆè·³è·ƒè¿æ¥ï¼‰
    
    å…¬å¼ï¼š
    out = F(x) + x
         â†‘      â†‘
       å·ç§¯   åŸå§‹è¾“å…¥
    
    ä¼˜åŠ¿ï¼š
    1. æ¢¯åº¦å¯ä»¥ç›´æ¥é€šè¿‡"æ·å¾„"å›ä¼  âœ…
    2. å­¦ä¹ æ®‹å·®ï¼ˆæ›´å®¹æ˜“ï¼‰ âœ…
    3. å…è®¸ç½‘ç»œæ›´æ·± âœ…
    4. æ€§èƒ½æ›´å¥½ âœ…
    
    
    YOLOv3 çš„æ®‹å·®å—è®¾è®¡ï¼š
    
    è¾“å…¥ (256 é€šé“)
      â†“
    Conv 1Ã—1, 128  (é™ç»´ï¼Œå‡å°‘è®¡ç®—)
      â†“
    Conv 3Ã—3, 256  (å‡ç»´ï¼Œæå–ç‰¹å¾)
      â†“
    (+) è¾“å…¥        (æ®‹å·®è¿æ¥)
      â†“
    è¾“å‡º (256 é€šé“)
    
    ä¸ºä»€ä¹ˆ 1Ã—1 â†’ 3Ã—3ï¼Ÿ
    â€¢ 1Ã—1 é™ç»´ï¼š256 â†’ 128ï¼ˆå‡å°‘ 3Ã—3 çš„è®¡ç®—é‡ï¼‰
    â€¢ 3Ã—3 ç‰¹å¾æå–ï¼šåœ¨ä½ç»´ç©ºé—´æå–ç‰¹å¾
    â€¢ å†å‡å› 256ï¼šä¿æŒé€šé“æ•°ä¸€è‡´
    â€¢ è¿™å« "bottleneck" è®¾è®¡ï¼ˆç“¶é¢ˆç»“æ„ï¼‰
    """
    
    print(explanation)


# ================================
# 7. æµ‹è¯•å’ŒéªŒè¯
# ================================

def test_darknet53():
    """æµ‹è¯• Darknet-53"""
    print("\n" + "=" * 80)
    print("Darknet-53 æµ‹è¯•")
    print("=" * 80)
    
    # åˆ›å»ºæ¨¡å‹
    model = Darknet53()
    model.eval()
    
    # ç»Ÿè®¡å‚æ•°
    total_params = sum(p.numel() for p in model.parameters())
    print(f"\nâœ… æ¨¡å‹åˆ›å»ºæˆåŠŸ")
    print(f"   æ€»å‚æ•°é‡: {total_params:,}")
    
    # æµ‹è¯•å‰å‘ä¼ æ’­
    print("\nğŸ”„ æµ‹è¯•å‰å‘ä¼ æ’­:")
    x = torch.randn(1, 3, 416, 416)
    
    with torch.no_grad():
        out_52, out_26, out_13 = model(x)
    
    print(f"   è¾“å…¥: {x.shape}")
    print(f"   è¾“å‡º1 (52Ã—52): {out_52.shape}  â† ç”¨äºæ£€æµ‹å°ç›®æ ‡")
    print(f"   è¾“å‡º2 (26Ã—26): {out_26.shape}  â† ç”¨äºæ£€æµ‹ä¸­ç›®æ ‡")
    print(f"   è¾“å‡º3 (13Ã—13): {out_13.shape}  â† ç”¨äºæ£€æµ‹å¤§ç›®æ ‡")
    
    # éªŒè¯æ®‹å·®å—
    print("\nğŸ” éªŒè¯æ®‹å·®å—:")
    res_block = ResidualBlock(256)
    x_test = torch.randn(1, 256, 52, 52)
    
    with torch.no_grad():
        out = res_block(x_test)
    
    print(f"   è¾“å…¥: {x_test.shape}")
    print(f"   è¾“å‡º: {out.shape}")
    print(f"   âœ… å½¢çŠ¶ä¿æŒä¸å˜ï¼ˆæ®‹å·®è¿æ¥çš„ç‰¹ç‚¹ï¼‰")


# ================================
# 8. æ¶æ„å¯è§†åŒ–
# ================================

def visualize_architecture():
    """å¯è§†åŒ–æ¶æ„"""
    print("\n" + "=" * 80)
    print("Darknet-53 å®Œæ•´æ¶æ„")
    print("=" * 80)
    
    architecture = """
    è¾“å…¥: 416Ã—416Ã—3
    â”œâ”€ Conv 3Ã—3, 32, stride=1      â†’ 416Ã—416Ã—32
    â”‚
    â”œâ”€ â”Œâ”€ Conv 3Ã—3, 64, stride=2   â†’ 208Ã—208Ã—64
    â”‚  â””â”€ ResBlockÃ—1
    â”‚
    â”œâ”€ â”Œâ”€ Conv 3Ã—3, 128, stride=2  â†’ 104Ã—104Ã—128
    â”‚  â””â”€ ResBlockÃ—2
    â”‚
    â”œâ”€ â”Œâ”€ Conv 3Ã—3, 256, stride=2  â†’ 52Ã—52Ã—256  â”€â”€â”
    â”‚  â””â”€ ResBlockÃ—8                              â”‚ è¾“å‡º1ï¼ˆç»†èŠ‚ï¼‰
    â”‚                                              â”‚ ç”¨äºæ£€æµ‹å°ç›®æ ‡
    â”‚                                              â”‚
    â”œâ”€ â”Œâ”€ Conv 3Ã—3, 512, stride=2  â†’ 26Ã—26Ã—512 â”€â”€â”¤
    â”‚  â””â”€ ResBlockÃ—8                              â”‚ è¾“å‡º2ï¼ˆä¸­ç­‰ï¼‰
    â”‚                                              â”‚ ç”¨äºæ£€æµ‹ä¸­ç›®æ ‡
    â”‚                                              â”‚
    â””â”€ â”Œâ”€ Conv 3Ã—3, 1024, stride=2 â†’ 13Ã—13Ã—1024â”€â”€â”˜
       â””â”€ ResBlockÃ—4                              â”‚ è¾“å‡º3ï¼ˆè¯­ä¹‰ï¼‰
                                                  â”‚ ç”¨äºæ£€æµ‹å¤§ç›®æ ‡
    
    æ®‹å·®å—ï¼ˆResBlockï¼‰ç»“æ„ï¼š
    x â†’ Conv1Ã—1(é™ç»´) â†’ Conv3Ã—3(å‡ç»´) â†’ (+)x â†’ out
    
    æ€»å±‚æ•°è®¡ç®—ï¼š
    â€¢ 1 ä¸ªåˆå§‹ Conv
    â€¢ 5 ä¸ªä¸‹é‡‡æ · Conv
    â€¢ (1+2+8+8+4) Ã— 2 = 46 ä¸ªæ®‹å·®å—å†…çš„ Conv
    â€¢ æ€»è®¡ï¼š1 + 5 + 46 = 52 â‰ˆ 53 å±‚ï¼ˆç®—æ³•ç•¥æœ‰ä¸åŒï¼‰
    """
    
    print(architecture)


# ================================
# ä¸»å‡½æ•°
# ================================

if __name__ == "__main__":
    # å¯¹æ¯”æ¶æ„
    compare_architectures()
    
    # è§£é‡Šæ®‹å·®å—
    explain_residual_block()
    
    # æµ‹è¯•æ¨¡å‹
    test_darknet53()
    
    # å¯è§†åŒ–æ¶æ„
    visualize_architecture()
    
    print("\n" + "=" * 80)
    print("ğŸ‰ Darknet-53 å­¦ä¹ å®Œæˆï¼")
    print("=" * 80)
    print("\nå…³é”®è¦ç‚¹:")
    print("1. æ®‹å·®è¿æ¥ï¼ˆResNet æ€æƒ³ï¼‰â† æ ¸å¿ƒåˆ›æ–°")
    print("2. æ›´æ·±çš„ç½‘ç»œï¼ˆ53 å±‚ vs 19 å±‚ï¼‰")
    print("3. å¤šå°ºåº¦è¾“å‡ºï¼ˆ52Ã—52, 26Ã—26, 13Ã—13ï¼‰")
    print("4. æ­¥é•¿ä¸º 2 çš„å·ç§¯ä¸‹é‡‡æ ·ï¼ˆä»£æ›¿ MaxPoolï¼‰")
    print("5. Bottleneck è®¾è®¡ï¼ˆ1Ã—1 é™ç»´ â†’ 3Ã—3 ç‰¹å¾ â†’ å‡ç»´ï¼‰")

