# YOLOv2 å­¦ä¹ ç¬”è®° - ä»£ç å¯¹ç…§

## ğŸ“š ä½ çš„ç¬”è®° vs ä»£ç å®ç°

---

## 1. é«˜ç²¾åº¦åˆ†ç±»å™¨ âœ…

### ğŸ“– ä½ çš„ç¬”è®°
> è¿™æ˜¯ä¸€ç§æ€æƒ³ï¼Œä½¿ç”¨ä¸¤ç§ä¸åŒå°ºå¯¸çš„å›¾ç‰‡æ•°æ®å¯¹æ¨¡å‹è¿›è¡Œé¢„è®­ç»ƒï¼Œä»è€Œä½¿æ¨¡å‹é€‚åº”é«˜åˆ†è¾¨ç‡å›¾ç‰‡çš„è¾“å…¥

### ğŸ’» å¯¹åº”å®ç°

**åŸç†**ï¼š
- **é˜¶æ®µ 1**: åœ¨ ImageNet ä¸Šç”¨ 224Ã—224 é¢„è®­ç»ƒåˆ†ç±»å™¨
- **é˜¶æ®µ 2**: ç”¨ 448Ã—448 å¾®è°ƒ 10 ä¸ª epoch
- **æ•ˆæœ**: æå‡çº¦ 4% mAP

**ä»£ç éªŒè¯**ï¼š
```python
# Darknet19 æ”¯æŒä»»æ„å°ºå¯¸è¾“å…¥
model = Darknet19(num_classes=1000)

# 224Ã—224 é¢„è®­ç»ƒ
x1 = torch.randn(1, 3, 224, 224)
output1 = model(x1)  # âœ… å¯ä»¥è¿è¡Œ

# 448Ã—448 å¾®è°ƒ
x2 = torch.randn(1, 3, 448, 448)
output2 = model(x2)  # âœ… å¯ä»¥è¿è¡Œ
```

**ä½ç½®**: `Darknet19.py` - æ•´ä¸ªæ¨¡å‹éƒ½æ”¯æŒå¤šå°ºåº¦

---

## 2. é”šæ¡† (Anchor Boxes) âœ…

### 2.1 Dimension Clusters (ç»´åº¦èšç±»)

#### ğŸ“– ä½ çš„ç¬”è®°
> ç”¨ k-means èšç±»æ¥è‡ªåŠ¨ä»è®­ç»ƒé›†ä¸­å­¦ä¹ å…ˆéªŒæ¡†ï¼ˆpriorsï¼‰çš„å°ºå¯¸

#### ğŸ’» å¯¹åº”å®ç°

**æ–‡ä»¶**: `../yolov2_implementation.py`

**æ ¸å¿ƒå‡½æ•°**:
```python
def kmeans_anchors(boxes, k=5, max_iter=300):
    """
    ä½¿ç”¨ K-means èšç±»ç”Ÿæˆ anchor boxes
    
    Args:
        boxes: (n, 2) - æ‰€æœ‰è®­ç»ƒæ¡†çš„å®½é«˜
        k: anchor boxes çš„æ•°é‡ï¼ˆYOLOv2 ç”¨ 5 ä¸ªï¼‰
        max_iter: æœ€å¤§è¿­ä»£æ¬¡æ•°
    
    Returns:
        anchors: (k, 2) - k ä¸ª anchor boxes çš„å°ºå¯¸
    """
```

**è·ç¦»åº¦é‡**:
```python
def iou_kmeans(box, centroids):
    """
    ä½¿ç”¨ 1 - IoU ä½œä¸ºè·ç¦»åº¦é‡
    
    ä¸ºä»€ä¹ˆä¸ç”¨æ¬§æ°è·ç¦»ï¼Ÿ
    - IoU ä¸æ£€æµ‹ä»»åŠ¡æ›´ç›¸å…³
    - å¯¹å°ºåº¦ä¸æ•æ„Ÿ
    """
    iou = è®¡ç®—äº¤å¹¶æ¯”
    return 1 - iou  # â† è¿™å°±æ˜¯ä½ ç¬”è®°ä¸­çš„ IOU-based Distance
```

**ä½ç½®**: `yolov2_implementation.py` ç¬¬ 44-88 è¡Œ

---

### 2.2 Direct Location Prediction (ç›´æ¥ä½ç½®é¢„æµ‹)

#### ğŸ“– ä½ çš„ç¬”è®°
> ä¸ºäº†è§£å†³é”šæ¡†å¸¦æ¥çš„ä¸ç¨³å®šæ€§ï¼ŒYOLOv2 ä¸é¢„æµ‹æ— çº¦æŸçš„åç§»é‡ï¼Œè€Œæ˜¯ä½¿ç”¨ logistic æ¿€æ´»å‡½æ•°å°†é¢„æµ‹çš„ (x, y) ä¸­å¿ƒç‚¹çº¦æŸåœ¨ç½‘æ ¼å•å…ƒå†…éƒ¨

#### ğŸ’» å¯¹åº”å®ç°

**æ–‡ä»¶**: `../yolov2_implementation.py`

**æ ¸å¿ƒä»£ç **:
```python
def decode_yolov2_predictions(predictions, anchors, ...):
    # æå–é¢„æµ‹å€¼
    tx = predictions[..., 0]  # ä¸­å¿ƒ x åç§»
    ty = predictions[..., 1]  # ä¸­å¿ƒ y åç§»
    tw = predictions[..., 2]  # å®½åº¦ç¼©æ”¾
    th = predictions[..., 3]  # é«˜åº¦ç¼©æ”¾
    
    # è§£ç è¾¹ç•Œæ¡†ï¼ˆå…³é”®ï¼ï¼‰
    bx = sigmoid(tx) + cx  # â† sigmoid çº¦æŸåˆ° [0,1]
    by = sigmoid(ty) + cy  # â† ç¡®ä¿ä¸­å¿ƒç‚¹åœ¨ grid cell å†…
    
    bw = pw Ã— exp(tw)      # â† å®½åº¦é¢„æµ‹
    bh = ph Ã— exp(th)      # â† é«˜åº¦é¢„æµ‹
```

**æ•°å­¦å…¬å¼**:
```
bx = Ïƒ(tx) + cx    # Ïƒ æ˜¯ sigmoidï¼Œcx æ˜¯ grid cell çš„ x åæ ‡
by = Ïƒ(ty) + cy    # cy æ˜¯ grid cell çš„ y åæ ‡
bw = pw Ã— e^tw     # pw æ˜¯ anchor çš„å®½åº¦
bh = ph Ã— e^th     # ph æ˜¯ anchor çš„é«˜åº¦
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**
- âœ… sigmoid å°† tx, ty çº¦æŸåˆ° [0, 1]
- âœ… ç¡®ä¿ä¸­å¿ƒç‚¹ä¸ä¼šè·‘åˆ°å…¶ä»– grid cell
- âœ… è®­ç»ƒæ›´ç¨³å®š

**ä½ç½®**: `yolov2_implementation.py` ç¬¬ 98-174 è¡Œ

---

### 2.3 IOU-based Distance

#### ğŸ“– ä½ çš„ç¬”è®°
> æ²¡æœ‰ä½¿ç”¨æ¬§æ°è·ç¦»ï¼Œè€Œæ˜¯ä½¿ç”¨äº† 1-IOU ä½œä¸ºè·ç¦»åº¦é‡

#### ğŸ’» å¯¹åº”å®ç°

**å·²åœ¨ 2.1 ä¸­è¯´æ˜**

**å…³é”®ä»£ç **:
```python
# K-means èšç±»æ—¶çš„è·ç¦»è®¡ç®—
def iou_kmeans(box, centroids):
    intersection = min(box[0], centroids[:, 0]) * min(box[1], centroids[:, 1])
    box_area = box[0] * box[1]
    centroid_area = centroids[:, 0] * centroids[:, 1]
    iou = intersection / (box_area + centroid_area - intersection)
    
    return 1 - iou  # â† è·ç¦» = 1 - IoU
```

**ä¼˜åŠ¿**:
- æ›´å…³æ³¨æ£€æµ‹ä»»åŠ¡æœ¬èº«ï¼ˆIoUï¼‰
- å¯¹æ¡†çš„å°ºåº¦ä¸æ•æ„Ÿ
- æ›´é€‚åˆç”Ÿæˆ anchor boxes

---

## 3. ç»†ç²’åº¦ç‰¹å¾æå– (Passthrough Layer) âœ…

### ğŸ“– ä½ çš„ç¬”è®°
> åœ¨ç½‘ç»œé€šè¿‡å¤šä¸ªå·ç§¯å±‚ä¸æ–­æå–å›¾ç‰‡ç‰¹å¾åˆ°åº•çš„åŒæ—¶ï¼Œä¼šä»ä¸­é—´éƒ¨åˆ†ï¼ˆç›´é€šå±‚ï¼‰å¯¹ç‰¹å¾å›¾ä¸æœ€åç‰¹å¾å›¾è¿›è¡Œæ‹¼æ¥ï¼Œä»è€Œå®ç°å¯¹å›¾åƒç»†ç²’åº¦ç‰¹å¾çš„æå–

### ğŸ’» å¯¹åº”å®ç°

**æ–‡ä»¶**: `../yolov2_implementation.py`

**æ ¸å¿ƒå‡½æ•°**:
```python
def passthrough_layer(x):
    """
    YOLOv2 çš„ Passthrough å±‚
    å°† 26Ã—26Ã—512 çš„ç‰¹å¾å›¾é‡ç»„ä¸º 13Ã—13Ã—2048
    
    ç±»ä¼¼äºåƒç´ é‡æ’ï¼ˆspace-to-depthï¼‰
    
    ç¤ºä¾‹:
        è¾“å…¥: 26Ã—26 ç‰¹å¾å›¾
        [a b c d]    é‡ç»„å    [a c]
        [e f g h]    ------>   [e g]
        å˜ä¸º 2Ã—2 ä¸”é€šé“æ•°Ã—4
    """
    batch, height, width, channels = x.shape
    
    # é‡å¡‘: (batch, 13, 2, 13, 2, 512)
    x = x.reshape(batch, height // 2, 2, width // 2, 2, channels)
    
    # è½¬ç½®: (batch, 13, 13, 2, 2, 512)
    x = x.transpose(0, 1, 3, 2, 4, 5)
    
    # åˆå¹¶: (batch, 13, 13, 2048)
    x = x.reshape(batch, height // 2, width // 2, channels * 4)
    
    return x
```

**å·¥ä½œåŸç†**:
```
26Ã—26Ã—512 (é«˜åˆ†è¾¨ç‡ç‰¹å¾)
    â†“ Passthrough (ç©ºé—´ â†’ é€šé“)
13Ã—13Ã—2048
    â†“ Concatenate
13Ã—13Ã—(2048 + 1024) = 13Ã—13Ã—3072
    â†“ åç»­å·ç§¯
æœ€ç»ˆæ£€æµ‹è¾“å‡º
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- âœ… ä¿ç•™é«˜åˆ†è¾¨ç‡ç‰¹å¾çš„ç»†èŠ‚ä¿¡æ¯
- âœ… æ”¹å–„å°ç›®æ ‡æ£€æµ‹
- âœ… ç±»ä¼¼ ResNet çš„è·³è·ƒè¿æ¥

**ä½ç½®**: `yolov2_implementation.py` ç¬¬ 216-246 è¡Œ

---

## 4. å¤šå°ºåº¦è®­ç»ƒ âœ…

### ğŸ“– ä½ çš„ç¬”è®°
> ç”±äºæ¨¡å‹æ˜¯å…¨å·ç§¯çš„ï¼Œè®­ç»ƒæ—¶æ¯ 10 ä¸ª batch å°±ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ–°çš„è¾“å…¥å°ºå¯¸ï¼Œè¿«ä½¿ç½‘ç»œå­¦ä¼šåœ¨å„ç§åˆ†è¾¨ç‡ä¸Šéƒ½èƒ½åšå¥½é¢„æµ‹ï¼Œä½¿åŒä¸€ä¸ªæ¨¡å‹åœ¨éƒ¨ç½²æ—¶å¯ä»¥è‡ªç”±æƒè¡¡é€Ÿåº¦å’Œç²¾åº¦

### ğŸ’» å¯¹åº”å®ç°

**è®­ç»ƒé…ç½®**:
```python
# YOLOv2 å¤šå°ºåº¦è®­ç»ƒ
sizes = [320, 352, 384, 416, 448, 480, 512, 544, 576, 608]

for i, (images, targets) in enumerate(dataloader):
    # æ¯ 10 ä¸ª batch åˆ‡æ¢å°ºå¯¸
    if i % 10 == 0:
        new_size = random.choice(sizes)
        # è°ƒæ•´å›¾åƒå°ºå¯¸
        images = F.interpolate(images, size=new_size)
    
    # å‰å‘ä¼ æ’­
    outputs = model(images)
    # ...è®­ç»ƒ...
```

**Darknet19 éªŒè¯**:
```python
model = Darknet19()

# å…¨å·ç§¯ï¼Œæ”¯æŒä»»æ„å°ºå¯¸
x_320 = torch.randn(1, 3, 320, 320)   # âœ… å¯ä»¥
x_416 = torch.randn(1, 3, 416, 416)   # âœ… å¯ä»¥
x_608 = torch.randn(1, 3, 608, 608)   # âœ… å¯ä»¥

# æ‰€æœ‰å°ºå¯¸éƒ½èƒ½å‰å‘ä¼ æ’­
model(x_320)
model(x_416)
model(x_608)
```

**æ•ˆæœ**:
- âœ… åŒä¸€æ¨¡å‹é€‚åº”ä¸åŒè¾“å…¥å°ºå¯¸
- âœ… æ¨ç†æ—¶å¯é€‰æ‹©é€Ÿåº¦ (320) æˆ–ç²¾åº¦ (608)
- âœ… æå‡æ¨¡å‹é²æ£’æ€§

**ä½ç½®**: `Darknet19.py` - å…¨å·ç§¯æ¶æ„å¤©ç„¶æ”¯æŒ

---

## 5. Batch Normalization âœ…

### ğŸ“– ä½ çš„ç¬”è®°
> åœ¨æ‰€æœ‰å·ç§¯å±‚ååŠ å…¥äº† BNï¼Œæ”¹å–„äº†æ”¶æ•›æ€§ï¼Œèµ·åˆ°äº†æ­£åˆ™åŒ–çš„ä½œç”¨

### ğŸ’» å¯¹åº”å®ç°

**æ–‡ä»¶**: `Darknet19.py`

**å®ç°ç»†èŠ‚**:
```python
class Darknet19(nn.Module):
    def __init__(self):
        super().__init__()
        
        # æ¯ä¸ªå·ç§¯å±‚éƒ½é… BN
        self.conv1 = nn.Conv2d(3, 32, 3, 1, 1, bias=False)  # â† bias=False
        self.bn1 = nn.BatchNorm2d(32)                       # â† å¯¹åº”çš„ BN
        
        self.conv2 = nn.Conv2d(32, 64, 3, 1, 1, bias=False)
        self.bn2 = nn.BatchNorm2d(64)
        
        # ... æ‰€æœ‰å·ç§¯å±‚éƒ½è¿™æ · ...
    
    def forward(self, x):
        # Conv â†’ BN â†’ Leaky ReLU
        x = F.leaky_relu(self.bn1(self.conv1(x)), 0.1)
        x = F.leaky_relu(self.bn2(self.conv2(x)), 0.1)
        # ... æ¯ä¸€å±‚éƒ½æ˜¯è¿™ä¸ªæ¨¡å¼ ...
```

**å…³é”®ç‚¹**:
1. **Conv2d çš„ bias=False**
   - å› ä¸º BN å·²ç»æœ‰åç½®å‚æ•°äº†
   - é¿å…å‚æ•°å†—ä½™

2. **é¡ºåº**: Conv â†’ BN â†’ Activation
   - æ ‡å‡†çš„æ·±åº¦å­¦ä¹ å®è·µ
   - BN åœ¨æ¿€æ´»å‡½æ•°ä¹‹å‰

3. **æ¿€æ´»å‡½æ•°**: Leaky ReLU (alpha=0.1)
   - é¿å… "dying ReLU" é—®é¢˜
   - è´Ÿå€¼æœ‰å°æ¢¯åº¦

**æ•ˆæœ**:
- âœ… æå‡çº¦ 2% mAP
- âœ… åŠ é€Ÿæ”¶æ•›
- âœ… å…è®¸æ›´å¤§çš„å­¦ä¹ ç‡
- âœ… æ­£åˆ™åŒ–æ•ˆæœï¼ˆå¯ä»¥ç§»é™¤ Dropoutï¼‰

**éªŒè¯**:
```python
# ç»Ÿè®¡ BN å±‚æ•°é‡
bn_count = sum(1 for m in model.modules() 
               if isinstance(m, nn.BatchNorm2d))
conv_count = sum(1 for m in model.modules() 
                 if isinstance(m, nn.Conv2d))

print(f"å·ç§¯å±‚: {conv_count}")    # 19 ä¸ª
print(f"BN å±‚: {bn_count}")       # 18 ä¸ªï¼ˆé™¤äº†æœ€åçš„åˆ†ç±»å±‚ï¼‰
```

---

## ğŸ“Š å®Œæ•´æµç¨‹æ€»ç»“

### YOLOv2 è®­ç»ƒæµç¨‹

```
é˜¶æ®µ 1: é¢„è®­ç»ƒ Darknet19
â”œâ”€ æ•°æ®é›†: ImageNet
â”œâ”€ è¾“å…¥: 224Ã—224 (ç¬”è®°ç¬¬ 1 ç‚¹)
â”œâ”€ ä¼˜åŒ–: BN åŠ é€Ÿæ”¶æ•› (ç¬”è®°ç¬¬ 5 ç‚¹)
â””â”€ è¾“å‡º: é¢„è®­ç»ƒæƒé‡

é˜¶æ®µ 2: é«˜åˆ†è¾¨ç‡å¾®è°ƒ
â”œâ”€ è¾“å…¥: 448Ã—448 (ç¬”è®°ç¬¬ 1 ç‚¹)
â”œâ”€ è®­ç»ƒ: 10 epochs
â””â”€ æ•ˆæœ: é€‚åº”é«˜åˆ†è¾¨ç‡

é˜¶æ®µ 3: æ£€æµ‹è®­ç»ƒ
â”œâ”€ æ·»åŠ æ£€æµ‹å¤´
â”œâ”€ ç”Ÿæˆ Anchors (ç¬”è®°ç¬¬ 2 ç‚¹)
â”‚   â””â”€ K-means èšç±» (1-IoU è·ç¦»)
â”œâ”€ Passthrough å±‚ (ç¬”è®°ç¬¬ 3 ç‚¹)
â”‚   â””â”€ èåˆ 26Ã—26 å’Œ 13Ã—13 ç‰¹å¾
â”œâ”€ å¤šå°ºåº¦è®­ç»ƒ (ç¬”è®°ç¬¬ 4 ç‚¹)
â”‚   â””â”€ æ¯ 10 batch åˆ‡æ¢å°ºå¯¸
â””â”€ é¢„æµ‹è§£ç 
    â””â”€ sigmoid çº¦æŸä¸­å¿ƒç‚¹ (ç¬”è®°ç¬¬ 2 ç‚¹)
```

---

## ğŸ¯ ä½ çš„ç¬”è®°å®Œæ•´æ€§æ£€æŸ¥

| ç¬”è®°å†…å®¹ | ä»£ç å¯¹åº” | å®Œæ•´åº¦ |
|---------|---------|--------|
| 1. é«˜ç²¾åº¦åˆ†ç±»å™¨ | âœ… Darknet19.py | 100% |
| 2. é”šæ¡† - Dimension Clusters | âœ… kmeans_anchors() | 100% |
| 2. é”šæ¡† - Direct Location | âœ… decode_yolov2_predictions() | 100% |
| 2. é”šæ¡† - IOU Distance | âœ… iou_kmeans() | 100% |
| 3. ç»†ç²’åº¦ç‰¹å¾æå– | âœ… passthrough_layer() | 100% |
| 4. å¤šå°ºåº¦è®­ç»ƒ | âœ… å…¨å·ç§¯æ¶æ„ | 100% |
| 5. Batch Normalization | âœ… æ¯ä¸ª Conv åéƒ½æœ‰ BN | 100% |

**æ€»ä½“è¯„ä»·**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ ä½ çš„ç¬”è®°éå¸¸å®Œæ•´ä¸”å‡†ç¡®ï¼

---

## ğŸ’¡ è¡¥å……çŸ¥è¯†ç‚¹

### YOLOv2 è¿˜æœ‰å…¶ä»–æ”¹è¿›

1. **å»æ‰å…¨è¿æ¥å±‚**
   - ä½¿ç”¨å…¨å·ç§¯ç½‘ç»œ
   - æ”¯æŒä»»æ„è¾“å…¥å°ºå¯¸

2. **æ–°çš„ç½‘ç»œç»“æ„**
   - Darknet19ï¼ˆ19 å±‚å·ç§¯ï¼‰
   - æ¯” VGG-16 æ›´å¿«æ›´å‡†

3. **è”åˆè®­ç»ƒ**
   - åŒæ—¶åœ¨æ£€æµ‹å’Œåˆ†ç±»æ•°æ®ä¸Šè®­ç»ƒ
   - YOLO9000 å¯ä»¥æ£€æµ‹ 9000+ ç±»åˆ«

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®Œæ•´å®ç° YOLOv2**
   - âœ… Darknet19 éª¨å¹²ï¼ˆå·²å®Œæˆï¼‰
   - â¬œ Passthrough å±‚
   - â¬œ æ£€æµ‹å¤´
   - â¬œ æŸå¤±å‡½æ•°
   - â¬œ è®­ç»ƒæµç¨‹

2. **å¯¹æ¯” YOLOv8**
   - æŸ¥çœ‹ `../comparison_demo.py`
   - ç†è§£æŠ€æœ¯æ¼”è¿›

3. **åŠ¨æ‰‹è®­ç»ƒ**
   - å‡†å¤‡æ•°æ®é›†
   - å‚è€ƒ `../training_guide.md`

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **è®ºæ–‡**: "YOLO9000: Better, Faster, Stronger"
- **ä»£ç **: `../yolov2_implementation.py` - æ ¸å¿ƒç®—æ³•å®ç°
- **å¯¹æ¯”**: `../comparison_demo.py` - YOLOv2 vs YOLOv8

---

**ä½ çš„å­¦ä¹ éå¸¸æ‰å®ï¼ç»§ç»­åŠ æ²¹ï¼** ğŸ‰

